<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Prolog XO</title>

  <!-- Bootstrap 4.5 -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
    integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
    integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
    crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"
    integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV"
    crossorigin="anonymous"></script>

  <!-- Vue.js -->
  <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

  <style>
    body {
      background: url('https://cdn.pixabay.com/photo/2015/05/28/01/52/court-787406_1280.jpg') no-repeat center center fixed;
      background-size: cover;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .modal-content {
      text-align: center;
      transition: background 0.3s;
    }

    .modal-content.win {
      background: #43a047 !important;
      color: #fff;
    }

    .modal-content.lose {
      background: #c62828 !important;
      color: #fff;
    }

    .modal-content.draw,
    .modal-content.invalid {
      background: #fbc02d !important;
      color: #fff;
    }

    .modal-title.win {
      color: #fff;
      background: #43a047;
    }

    .modal-title.lose {
      color: #fff;
      background: #c62828;
    }

    .modal-title.draw,
    .modal-title.invalid {
      color: #fff;
      background: #fbc02d;
    }

    .modal-title {
      border-radius: 8px;
      padding: 10px 0;
      font-size: 2rem;
      font-weight: bold;
      margin: 0 auto;
      width: 100%;
    }

    #app {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    #content {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 30px 0;
    }

    .bodyBlock {
      background: #f9635c;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 30px;
      width: 100%;
      max-width: 700px;
      text-align: center;
    }

    .boardCell {
      height: 100px;
      width: 100px;
      text-align: center;
      vertical-align: middle;
      font-size: 65px;
      border: 2px solid black;
      cursor: pointer;
    }

    table#gameBoard {
      margin: 0 auto;
    }

    .form-group {
      margin: 10px 15px;
      padding: 0 10px;
    }

    #boardSizeInput {
      width: 65px;
      text-align: center;
    }
  </style>
</head>

<body>
  <div id="app">
    <div id="content" class="container">
      <div id="game_info" class="bodyBlock">
        <h3>Prolog XO</h3>
      </div>

      <div id="gameOptions" class="bodyBlock d-flex justify-content-center">
        <form class="form-inline justify-content-center">
          <div class="form-group mx-2">
            <div class="btn-group" role="group">
              <button type="button" class="btn btn-danger" :disabled="playerSymbol === 'X'"
                @click="setSymbol('X')">X</button>
              <button type="button" class="btn btn-primary" :disabled="playerSymbol === 'O'"
                @click="setSymbol('O')">O</button>
            </div>
          </div>
          <div class="form-group custom-slider mx-2">
            <label for="difficultySlider" class="mr-2"><strong>Nivel de dificultad:</strong></label>
            <input type="range" class="form-control-range white-slider" min="1" :max="maxDifficultyLevel"
              v-model="difficultyLevel" id="difficultySlider">
          </div>
          <button type="button" class="btn btn-dark custom-reset-btn mx-2" @click="resizeBoard">Reset</button>
        </form>
      </div>

      <div id="theGame" class="bodyBlock">
        <table id="gameBoard">
          <tr v-for="(row, rowIndex) in board" :key="rowIndex">
            <td v-for="(cell, cellIndex) in row" :key="cellIndex" class="boardCell"
              @click="makeMove(rowIndex, cellIndex)">
              {{ cell }}
            </td>
          </tr>
        </table>
      </div>
    </div>

    <div class="modal fade" id="infoModal" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content" :class="infoModalClass">
          <div class="modal-header border-0">
            <h5 class="modal-title w-100 text-center">{{ infoModalText }}</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-footer border-0 justify-content-center">
            <button type="button" class="btn btn-light" data-dismiss="modal" @click="resizeBoard">Cerrar</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const App = {
      data() {
        return {
          board: null,
          boardSize: 3,
          playerSymbol: "X",
          difficultyLevel: 0,
          maxDifficultyLevel: 9,
          infoModalText: null,
          infoModalClass: "",
          isWinner: null
        }
      },

      mounted() {
        this.difficultyLevel = this.boardSize * this.boardSize;
        this.resizeBoard();
      },

      methods: {
        createBoard(size) {
          const newBoard = [];
          for (let i = 0; i < size; i++) {
            newBoard[i] = [];
            for (let j = 0; j < size; j++) {
              newBoard[i][j] = "";
            }
          }
          return newBoard;
        },

        resizeBoard() {
          this.board = this.createBoard(this.boardSize);
          this.isWinner = null;
        },

        postJsonData() {
          return {
            board: this.board,
            difficultyLevel: this.difficultyLevel,
            symbol: this.playerSymbol
          }
        },

        makeMove(rowIndex, cellIndex) {
          if (this.board[rowIndex][cellIndex] !== "") {
            this.showInfoModal("Movimiento inválido!!!");
          } else {
            this.board[rowIndex][cellIndex] = this.playerSymbol;
            axios.post("/api/make_move", this.postJsonData()).then(response => {
              this.board = response.data.board;
              this.getIsWinner();
            }).catch(() => {
              this.showInfoModal("¡Es muy difícil! Por favor, baja la dificultad.");
            });
          }
        },

        getIsWinner() {
          axios.post("/api/is_winner", this.postJsonData()).then(response => {
            const isWinner = response.data.result;
            if (isWinner === true) {
              this.showInfoModal("GANASTEEE!!!");
            } else if (isWinner === false) {
              this.showInfoModal("PERDISTEEE!!!");
            } else if (this.checkIsDraw()) {
              this.showInfoModal("EMPATEEE");
            }
          });
        },

        checkIsDraw() {
          for (let i = 0; i < this.board.length; i++) {
            for (let j = 0; j < this.board[i].length; j++) {
              if (this.board[i][j] === "") {
                return false;
              }
            }
          }
          return true;
        },

        setSymbol(symbol) {
          this.playerSymbol = symbol;
          this.resizeBoard();
        },

        showInfoModal(text) {
          this.infoModalText = text;
          if (text === "GANASTEEE!!!") {
            this.infoModalClass = "win";
          } else if (text === "PERDISTEEE!!!") {
            this.infoModalClass = "lose";
          } else if (text === "EMPATEEE") {
            this.infoModalClass = "draw";
          } else if (text === "Movimiento inválido!!!") {
            this.infoModalClass = "invalid";
          } else {
            this.infoModalClass = "";
          }
          $("#infoModal").modal("show");
        }
      }
    }

    new Vue(App).$mount("#app");
  </script>
</body>

</html>